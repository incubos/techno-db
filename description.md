Микросервис сообщений
====== 
## Задачи и их особенности
### Какие задачи необходимо решить?
* **Дать группам от двух до 20 человек переписываться между собой (добавлять сообщения и читать сообщения)**
* Показывать список последних переписок с превью последнего сообщения &#x1f680;
* Дать возможность просматривать отсортированный список всех переписок 
* Показывать последние сообщения в конкретной переписке &#x1f680;
* Дать возможность просматривать все сообщения в переписке 
* Дать возможность производить поиск внутри переписки (иногда)
* Дать возможность производить поиск по всем сообщениям (иногда)
* Дать возможность редактировать недавание (отправленные не более чем промежуток времени N назад) сообщения
* Дать пользователю возможность помечать  сообщения как удаленные (скрывать отображение для себя)
* Дать пользователю возможность помечать переписки как удаленные (скрывать отображение для себя)
* Дать возможность “прикреплять” мультимедиа файлы
* Дать возможность пересылать сообщения
* Оповещать о новых сообщениях

### Основные требования целостности
* Если пользователь П1 видит сообщение С1 от  пользователя П2 как полученное, то пользователь П2 должен видеть сообщение С1 как отправленное пользователю П1, и наоборот.
* Сообщение С1 должно иметь одно и то же содержание для всех пользователей
* Сообщения должны иметь единый порядок сортировки для всех пользователей в рамках переписки

### Ограничения
* Необходимо обеспечить невозможность несанкционированной отправки, чтения, редактирования, удаления, поиска сообщений.
### Особенности
* Предполагаем, что хранением  мультимедиа файлов (например, изображения или видео) будут заниматься специализированные микросервисы. Микросервис сообщений хранит только пометки о “прикрепленных” файлах и ссылки на них.
* Отправкой уведомлений о новых сообщениях занимаются другие микросервисы

## Данные и хранение
### Какие данные имеются
* Текстовые сообщения
* Прикрепленные файлы и медиа (видео, аудио, изображения (gif, png, ...),документы)

### Размеры и их ограничения
* Текстовое сообщение от 1 до 4096
* Макс. вложений в ЛС – 10 
* Макс. количество собеседников в диалогах – 30 собеседников
* Максимальная продолжительность аудиосообщения 3 минуты

### Что нам потребуется для хранения
1. Хранилище, оптимизированное под поиск (напрмиер, с полнотекстовым индексом)
2. Хранилище для долгосрочного хранения данных
3. Хранилище для  “оперативных” данных (добавление, редактирование)
4. Механизм перехода между хранилищами

### Концептуальные сущности
Информация о сообщении
|**MessageData**|
| ------------- |
| id            |
| text          |
| author        |
| attachments   |
| conversation  |
| timestamp     |
Информация о сообщении, связанная с конкретным пользователем
|**UserMessageData**|
| ----------------- |
| readStatus        |
| deleteStatus      |
| favoriteStatus    |
Информация об обсуждении
|**ConversationData**|
| -----------------  |
| participators      |
| messages           |
| name               |
Информация об обсуждении, связанная с конкретным пользователем
|**UserConversationData**|
| -----------------      |
| muteStatus             |
| favoriteStatus         |
Информация о списке переписок конкретного пользователя
|**UserConversationList**|
| -----------------      |
| name                   |
| lastMessagePreview     |
| lastMessageTimestamp   |

## Методы API
**Метод отправки сообщения sendMessage**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| conversation  |Обсуждение          |
| content       |Содержимое сообщения|
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод редактирования сообщения editMessage**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| message_id    |id сообщения        |
| conversation  |Обсуждение          |
| content       |Содержимое сообщения|
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод удаления сообщения removeMessage**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| message_id    |id сообщения        |
| conversation  |Обсуждение          |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод удаления обсуждения removeConversation**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| conversation  |Обсуждение          |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод создания обсуждения createConversation**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| participators |Набор участников    |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |
| conversation  |Обсуждение          |

**Метод добавления участников в обсуждение addParticipatorsToConversation**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| conversation  |Обсуждение          |
| participators |Набор участников    |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод удаления участников из обсуждения removeParticipatorsFromConversation**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| conversation  |Обсуждение          |
| participators |Набор участников    |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |

**Метод поиска текста в обсуждении searchTextInConversation**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| needle        |Текст поиска        |
| conversation  |Обсуждение          |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |
| messages      |Набор сообщений     |

**Метод поиска текста во всех обсуждениях searchTextInAllConversations**
Запрос
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| user_id       |id пользователя     |
| needle        |Текст поиска        |
| timestamp     |Временная отметка   |
| security_token|Токен безопасности  |
Ответ
|**Параметр**   |**Описание**        |
| --------------|--------------------|
| success       |Результат           |
| messages      |Набор сообщений     |
